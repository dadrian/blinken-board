<html>
<head>
<meta name="viewport" content="width=device-width, user-scalable=no" />

<style>

body, html {
    overflow-x: hidden;
    overflow-y: auto;
}

#error {
    opacity: 0.7;
    position: absolute;
    text-align: center;
    padding-top: 10%;
    padding-bottom: 10%;
    background-color: #0f0;
    /*display: none;*/
    top: 10%;
    height: 100px;
    left: 20%;
    width: 60%;
    border: 1px solid #000;
    color: #fff;
}

#socketStatus {
    display: none;
}

</style>

<script src="jquery-2.1.4.min.js"></script>
<script language="JavaScript">

function point_it(event){
    pos_x = event.offsetX ? (event.offsetX): event.pageX-document.getElementById("pointer_div").offsetLeft;
    pos_y = event.offsetY ? (event.offsetY): event.pageY-document.getElementById("pointer_div").offsetTop;

    console.log('x: ' + pos_x + ', y: ' + pos_y);
}

var buttons = [
{start: [0.77, 0.50], end: [0.92, 0.92], button: 'A', pressed: false},
{start: [0.62, 0.50], end: [0.765, 0.92], button: 'B', pressed: false},
{start: [0.475, 0.60], end: [0.58, 0.80], button: 'Start', pressed: false},
{start: [0.34, 0.60], end: [0.45, 0.80], button: 'Select', pressed: false},

{start: [0.13, 0.30], end: [0.21, 0.51], button: 'Up', pressed: false},
{start: [0.21, 0.51], end: [0.30, 0.69], button: 'Right', pressed: false},
{start: [0.13, 0.69], end: [0.21, 0.89], button: 'Down', pressed: false},
{start: [0.04, 0.51], end: [0.13, 0.69], button: 'Left', pressed: false},

{start: [0.04, 0.30], end: [0.17, 0.60], button: 'UpLeft', pressed: false},
{start: [0.17, 0.30], end: [0.30, 0.60], button: 'UpRight', pressed: false},
{start: [0.04, 0.60], end: [0.17, 0.89], button: 'DownLeft', pressed: false},
{start: [0.17, 0.60], end: [0.30, 0.89], button: 'DownRight', pressed: false},

];

function show_boundaries()
{
    var i;
    var tot_w = $(window).width();
    var tot_h = tot_w * 2411/5663;  // resolution of the image

    for (i=0; i<buttons.length; i++) {
        d = document.createElement('div');
        d.style.position = "absolute";
        d.style.left = Math.floor(buttons[i].start[0]*tot_w) + "px";
        d.style.top = Math.floor(buttons[i].start[1]*tot_h) + "px";
        d.style.width = Math.floor((buttons[i].end[0]-buttons[i].start[0])*tot_w) + "px";
        d.style.height = Math.floor((buttons[i].end[1]-buttons[i].start[1])*tot_h) + "px";
        d.style.background = "rgba(0, 255, 0, 0.5)";
        document.body.appendChild(d);
    }
}


function get_button(pct_x, pct_y)
{
    var i;
    for (i=0; i<buttons.length; i++) {
        if (pct_x > buttons[i].start[0] && pct_y > buttons[i].start[1] &&
            pct_x < buttons[i].end[0] && pct_y < buttons[i].end[1]) {

            return i;
        }
    }
    return -1;
}


var touches = [];

var websocket;

function button_released(button) {
    console.log('off: ' + button.button);
    websocket.send('-' + button.button);
}

function button_pressed(button) {
    console.log('on: ' + button.button);
    websocket.send('+' + button.button);
}

var display_error = false;

window.addEventListener('load', function(){
    var tot_w = $(window).width();
    var tot_h = tot_w * 2411/5663;  // resolution of the image
    websocket = new WebSocket('ws://wallhacks.xyz:8765/controller');
    function status(m) { document.getElementById('socketStatus').innerHTML = m; }
    websocket.onopen  = function(e) {
                            status('CONNECTED');
                            document.getElementById('error').style.display = 'none';
                            display_error = false;
                            token = document.location.hash.substr(1);
                            websocket.send(token);
                        };
    websocket.onclose = function(e) {

                            if (!display_error) {
                                document.getElementById('error').style.display = 'block';
                                document.getElementById('error').style.backgroundColor = '#f00';
                                document.getElementById('error_str').innerHTML = 'Error: disconnected';
                            }
                        };
    websocket.onerror = function(e) { status('ERROR: ' + e.data); };
    websocket.onmessage = function(e) {
                            status('data: ' + e.data);

                            var err_str = '';
                            if (e.data == '!old_token') {
                                err = 'Your token has expired, rescan a more recent QR code!';
                            } else if (e.data == '!bad_token') {
                                err = 'Your token is too invalid.';
                            } else if (e.data == '!timeout') {
                                err = 'You have timed out. Please refresh or rescan the QR code';
                            } else {
                                err = e.data;
                            }

                            document.getElementById('error').style.display = 'block';
                            document.getElementById('error').style.backgroundColor = '#f00';
                            document.getElementById('error_str').innerHTML = err;
                            display_error = true;
                        };

    //show_boundaries();

    $('img').bind('contextmenu', function(e) {
        return false;
    });

    document.body.addEventListener('touchstart', function(e){
        var i;
        for (i=0; i<e.changedTouches.length; i++) {
            pct_x = (e.changedTouches[i].pageX / tot_w);
            pct_y = (e.changedTouches[i].pageY / tot_h);
            console.log('[' + pct_x + ', ' + pct_y + ']');

            idx = get_button(pct_x, pct_y);
            if (idx >= 0) {
                var button = buttons[idx];
                //console.log('(' + pct_x + ', ' + pct_y + '): ' + button.button);
                buttons[idx].pressed = true;
                touches[i] = {button: button};
                button_pressed(button);
            }
        }
    }, false);


    function touchend (e){
        var i;
        for (i=0; i<e.changedTouches.length; i++) {
            pct_x = (e.changedTouches[i].pageX / tot_w);
            pct_y = (e.changedTouches[i].pageY / tot_h);

            idx = get_button(pct_x, pct_y);
            if (idx >= 0) {
                button = buttons[idx];
                if (button.pressed) {
                    delete touches[i];
                    buttons[idx].pressed = false;
                    button_released(button);
                }
            }
        }
    }

    document.body.addEventListener('touchend', touchend, false);
    document.body.addEventListener('touchcancel', touchend, false);


    document.body.addEventListener('touchmove', function(e){
        var i;
        for (i=0; i<e.changedTouches.length; i++) {
            pct_x = (e.changedTouches[i].pageX / tot_w);
            pct_y = (e.changedTouches[i].pageY / tot_h);

            idx = get_button(pct_x, pct_y);
            if (idx >= 0) {
                button = buttons[idx];
                if (touches[i] == undefined) {
                    touches[i] = {button: button};
                    buttons[idx].pressed = true;
                    button_pressed(button);
                } else if (touches[i].button.button != button.button) {
                    buttons[idx].pressed = true;
                    button_pressed(button);
                    button_released(touches[i].button);
                    //delete touches[i];
                    touches[i].button = button;
                }
                // Still down...
            } else if (touches[i] != undefined) {
                button_released(touches[i].button);
                delete touches[i];
                // Hmmm. lost a button?
                //console.log(e);
            }
        }
    }, false);
}, false)

</script>


</head>
<body>

<div id="error"><h1><div id="error_str">Connecting...</div></h1></div>
<img id="img" src="nes-controller.jpg" width="100%"/>

<div id="socketStatus"></div>

</body>
</html>
